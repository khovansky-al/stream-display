{"version":3,"file":"stream-display.js","sources":["../src/StreamDisplay.ts"],"sourcesContent":["const DISPLAY_MEDIA_OPTIONS: MediaStreamConstraints = {\n  video: {\n    cursor: 'never'\n  },\n  audio: false\n}\n\ndeclare global {\n  /*\n    MediaDevices.getDisplayMedia is currently typed incorrectly\n    https://github.com/microsoft/TypeScript/issues/31821\n  */\n  interface MediaDevices {\n    getDisplayMedia(constraints: MediaStreamConstraints): Promise<MediaStream>;\n  }\n\n  interface MediaTrackConstraints {\n    cursor: ConstrainDOMString;\n  }\n\n  interface MediaStreamConstraints {\n    video?: MediaTrackConstraints | boolean;\n    audio?: MediaTrackConstraints | boolean;\n  }\n}\n\ntype CallbackFn = (imageData: ImageData) => any\n\nexport default class StreamDisplay {\n  private video: HTMLVideoElement;\n  private canvas: HTMLCanvasElement;\n  private canvasContext: CanvasRenderingContext2D;\n  private rAFId: number = 0;\n  private callback: CallbackFn;\n\n  public streamHeight: number = 0;\n  public streamWidth: number = 0;\n\n  constructor(callback: CallbackFn) {\n    this.video = document.createElement('video');\n    this.canvas = document.createElement('canvas');\n\n    const context = this.canvas.getContext('2d');\n    if (context == null) {\n      throw 'Cannot initialize canvas context'\n    }\n\n    this.canvasContext = context;\n    this.callback = callback;\n  }\n\n  startCapture = async () => {\n    const devices = navigator.mediaDevices as MediaDevices;\n    this.video.srcObject = await devices.getDisplayMedia(DISPLAY_MEDIA_OPTIONS);\n    this.video.play();\n\n    this.setupCanvas();\n    this.rAFId = requestAnimationFrame(this.stream);\n  }\n\n  stopCapture = () => {\n    cancelAnimationFrame(this.rAFId);\n\n    const videoSource = this.video.srcObject as MediaStream;\n    const tracks = videoSource.getTracks();\n\n    tracks.forEach(track => track.stop());\n  }\n\n  private setupCanvas() {\n    const videoSource = this.video.srcObject as MediaStream;\n    const videoTrack = videoSource.getVideoTracks()[0];\n\n    const { height, width } = videoTrack.getSettings();\n\n    this.streamWidth = width || 0;\n    this.streamHeight = height || 0;\n\n    this.canvas.height = this.streamHeight;\n    this.canvas.width = this.streamWidth;\n  }\n\n  private stream = () => {\n    this.drawVideoToCanvas();\n    this.callback(this.getImageData());\n\n    this.rAFId = requestAnimationFrame(this.stream);\n  }\n\n  private drawVideoToCanvas() {\n    const { streamHeight, streamWidth, video, canvasContext } = this;\n    canvasContext.drawImage(video, 0, 0, streamWidth, streamHeight);\n  }\n\n  private getImageData(): ImageData {\n    const { streamHeight, streamWidth, canvasContext } = this;\n    return canvasContext.getImageData(0, 0, streamWidth, streamHeight);\n  }\n}\n"],"names":["DISPLAY_MEDIA_OPTIONS","video","cursor","audio","callback","this","devices","navigator","mediaDevices","_a","getDisplayMedia","srcObject","_b","play","setupCanvas","rAFId","requestAnimationFrame","stream","cancelAnimationFrame","_this","getTracks","forEach","track","stop","drawVideoToCanvas","getImageData","document","createElement","canvas","context","getContext","canvasContext","StreamDisplay","getVideoTracks","height","width","streamWidth","streamHeight","drawImage"],"mappings":"m/CAAMA,EAAgD,CACpDC,MAAO,CACLC,OAAQ,SAEVC,OAAO,qBAkCP,WAAYC,GAAZ,WANQC,WAAgB,EAGjBA,kBAAuB,EACvBA,iBAAsB,EAe7BA,kBAAe,wGAEU,OADjBC,EAAUC,UAAUC,aAC1BC,EAAAJ,KAAKJ,SAAwBK,EAAQI,gBAAgBV,kBAArDS,EAAWE,UAAYC,SACvBP,KAAKJ,MAAMY,OAEXR,KAAKS,cACLT,KAAKU,MAAQC,sBAAsBX,KAAKY,kBAG1CZ,iBAAc,WACZa,qBAAqBC,EAAKJ,OAENI,EAAKlB,MAAMU,UACJS,YAEpBC,QAAQ,SAAAC,GAAS,OAAAA,EAAMC,UAgBxBlB,YAAS,WACfc,EAAKK,oBACLL,EAAKf,SAASe,EAAKM,gBAEnBN,EAAKJ,MAAQC,sBAAsBG,EAAKF,SA/CxCZ,KAAKJ,MAAQyB,SAASC,cAAc,SACpCtB,KAAKuB,OAASF,SAASC,cAAc,UAErC,IAAME,EAAUxB,KAAKuB,OAAOE,WAAW,MACvC,GAAe,MAAXD,EACF,KAAM,mCAGRxB,KAAK0B,cAAgBF,EACrBxB,KAAKD,SAAWA,EAkDpB,OA7BU4B,wBAAR,WACE,IAGMvB,EAHcJ,KAAKJ,MAAMU,UACAsB,iBAAiB,iBAExCC,WAAQC,UAEhB9B,KAAK+B,YAAcD,GAAS,EAC5B9B,KAAKgC,aAAeH,GAAU,EAE9B7B,KAAKuB,OAAOM,OAAS7B,KAAKgC,aAC1BhC,KAAKuB,OAAOO,MAAQ9B,KAAK+B,aAUnBJ,8BAAR,WACQ,IAAEK,oBAAcD,mBAAanC,gCACrBqC,UAAUrC,EAAO,EAAG,EAAGmC,EAAaC,IAG5CL,yBAAR,WACQ,IAAEK,oBAAcD,mBACtB,0BAAqBX,aAAa,EAAG,EAAGW,EAAaC"}